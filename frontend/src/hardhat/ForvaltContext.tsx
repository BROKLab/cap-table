/* Autogenerated file. Do not edit manually. */
/* tslint:disable */
/* eslint-disable */
import { providers, Signer, ethers } from "ethers";
import React, { useEffect, useState } from "react";
import Web3Modal, { IProviderOptions } from "web3modal";
import { AuthProvider } from "./typechain/AuthProvider";
import { AuthProvider__factory } from "./typechain/factories/AuthProvider__factory";
import { ERC1400 } from "./typechain/ERC1400";
import { ERC1400__factory } from "./typechain/factories/ERC1400__factory";
import { ERC1820Registry } from "./typechain/ERC1820Registry";
import { ERC1820Registry__factory } from "./typechain/factories/ERC1820Registry__factory";
import { CapTableQue } from "./typechain/CapTableQue";
import { CapTableQue__factory } from "./typechain/factories/CapTableQue__factory";
import { CapTableRegistry } from "./typechain/CapTableRegistry";
import { CapTableRegistry__factory } from "./typechain/factories/CapTableRegistry__factory";
import { ERC1400AuthValidator } from "./typechain/ERC1400AuthValidator";
import { ERC1400AuthValidator__factory } from "./typechain/factories/ERC1400AuthValidator__factory";
import WalletConnectQrcodeModal from "@walletconnect/qrcode-modal";
import { SIGNER_EVENTS, WalletConnectSigner } from "@symfoni/walletconnect-v2-ethers-signer";
import { getERC1400 } from "./contracts/ERC1400";
import { LiteralUnion } from "react-hook-form";

const emptyContract = {
    instance: undefined,
    factory: undefined
};
const defaultProvider: providers.Provider | undefined = undefined;
export const ProviderContext = React.createContext<[providers.Provider | undefined, React.Dispatch<React.SetStateAction<providers.Provider | undefined>>]>([defaultProvider, () => { }]);
const defaultCurrentAddress: string = "";
export const CurrentAddressContext = React.createContext<[string, React.Dispatch<React.SetStateAction<string>>]>([defaultCurrentAddress, () => { }]);
const defaultSigner: Signer | undefined = undefined;
export const SignerContext = React.createContext<[Signer | undefined, React.Dispatch<React.SetStateAction<Signer | undefined>>]>([defaultSigner, () => { }]);




export const ERC1400Context = React.createContext<SymfoniERC1400Context>(undefined!);
export const SymfoniContext = React.createContext<SymfoniContextInterface>(undefined!);

export const AuthProviderContext = React.createContext<SymfoniAuthProvider>(emptyContract);
export const ERC1820RegistryContext = React.createContext<SymfoniERC1820Registry>(emptyContract);
export const CapTableQueContext = React.createContext<SymfoniCapTableQue>(emptyContract);
export const CapTableRegistryContext = React.createContext<SymfoniCapTableRegistry>(emptyContract);
export const ERC1400AuthValidatorContext = React.createContext<SymfoniERC1400AuthValidator>(emptyContract);

export type SymfoniERC1400Context = {
    instance?: ERC1400;
    factory?: ERC1400__factory;
    connect: (address: string) => void;
};

export interface SymfoniProps {
    autoInit?: boolean;
    showLoading?: boolean;
    loadingComponent?: React.ReactNode;
}

export interface SymfoniAuthProvider {
    instance?: AuthProvider;
    factory?: AuthProvider__factory;
}
export interface SymfoniERC1820Registry {
    instance?: ERC1820Registry;
    factory?: ERC1820Registry__factory;
}

export interface SymfoniCapTableQue {
    instance?: CapTableQue;
    factory?: CapTableQue__factory;
}

export interface SymfoniCapTableRegistry {
    instance?: CapTableRegistry;
    factory?: CapTableRegistry__factory;
}

export interface SymfoniERC1400AuthValidator {
    instance?: ERC1400AuthValidator;
    factory?: ERC1400AuthValidator__factory;
}

export type ProviderTypes = "hardhat" | "walletConnectV2" | "web3modal"
const PROVIDERS = ["hardhat", "walletConnectV2", "web3modal"]

// export const Providers ={
//     hardhat: "hardhat",
//     walletConnectV2: "walletConnectV2",
//     web3modal: "web3modal"
// }
export type SignerTypes = "walletConnectV2" | "mnemonic" | "prompt" | "web3modal"
const SIGNERS = ["walletConnectV2", "mnemonic", "prompt", "web3modal"]
export interface InitOpts {
    provider?: ProviderTypes,
    forceSigner?: boolean
}

export enum STATE {
    DEFAULT,
    INITIALIZING,
    PROVIDER_READY,
    PROVIDER_SIGNER_READY
}

export interface SymfoniContextInterface {
    init: (opts?: InitOpts) => void
    messages: string[];
    forceSigner: boolean
    chainId?: number
    providers: typeof PROVIDERS;
    selectedProvider: ProviderTypes
    provider: providers.Provider
    signers: typeof SIGNERS
    selectedSigner: SignerTypes
    signer?: Signer
    address?: string
    state: STATE
    loading: boolean
    ready: boolean
    hasSigner: boolean
}
export const Symfoni: React.FC<SymfoniProps> = ({
    showLoading = true,
    autoInit = true,
    ...props
}) => {
    const [state, setState] = useState<STATE>(STATE.DEFAULT);
    const [forceSigner, setForceSigner] = useState<boolean>(false);
    const [chainId, setChainId] = useState<number>(undefined!);
    const [messages, setMessages] = useState<string[]>([]);

    const [selectedProvider, setSelectedProvider] = useState<ProviderTypes>("walletConnectV2");
    const [provider, setProvider] = useState<providers.Provider>(undefined!);
    const providers = PROVIDERS

    const [selectedSigner, setSelectedSigner] = useState<SignerTypes>("walletConnectV2");
    const [signer, setSigner] = useState<Signer | undefined>(undefined);
    const signers = SIGNERS
    const loading = state === STATE.DEFAULT || state === STATE.INITIALIZING
    const ready = state === STATE.PROVIDER_READY || state === STATE.PROVIDER_SIGNER_READY
    const hasSigner = state === STATE.PROVIDER_SIGNER_READY

    const [address, setAddress] = useState<string>();

    const [ERC1400, setERC1400] = useState<SymfoniERC1400Context>(undefined!);



    const [AuthProvider, setAuthProvider] = useState<SymfoniAuthProvider>(emptyContract);
    const [ERC1820Registry, setERC1820Registry] = useState<SymfoniERC1820Registry>(emptyContract);
    const [CapTableQue, setCapTableQue] = useState<SymfoniCapTableQue>(emptyContract);
    const [CapTableRegistry, setCapTableRegistry] = useState<SymfoniCapTableRegistry>(emptyContract);
    const [ERC1400AuthValidator, setERC1400AuthValidator] = useState<SymfoniERC1400AuthValidator>(emptyContract);


    const getProvider = async () => {
        if (provider) {
            return provider
        }
        if (selectedProvider === "walletConnectV2") {
            setSelectedProvider("walletConnectV2")
            return new ethers.providers.JsonRpcProvider({
                url: "http://127.0.0.1:8545",
            });
        }
        throw Error("Must be able to initate a provider")
    };

    const getSigner = async (_provider: providers.Provider) => {
        return new Promise<Signer | undefined>(async (resolve) => {
            let resolved = false
            if (signer) {
                return resolve(signer)
            }
            const _signer = new WalletConnectSigner().connect(_provider);
            _signer.on(SIGNER_EVENTS.uri, (uri: any) => {
                console.log("NEED URI QR CODE")
                console.log(uri)
            });
            _signer.on(SIGNER_EVENTS.statusUpdate, (session: any) => {
                if (!resolved) {
                    resolved = true
                    return resolve(_signer)
                }
            });
            setTimeout(() => {
                if (!resolved && !forceSigner) {
                    console.log("Did not get signer within 1 sek, returning undefined")
                    resolved = true
                    return resolve(undefined)
                }
            }, 500)
            await _signer.open();
        })
    };

    const init = (opts: InitOpts = {}) => {
        if (opts.provider && opts.provider !== selectedProvider) {
            setSelectedProvider(opts.provider)
        }
        if (opts.forceSigner && opts.forceSigner !== forceSigner)
            setForceSigner(forceSigner)
        setState(STATE.INITIALIZING)
    }

    const connectERC1400 = (address?: string) => {
        setERC1400(getERC1400(provider, chainId, connectERC1400, signer, address))
    }
    // Should always get provider or fail
    // Should try and get signer, but not interrupt if not signer found, so fail early
    useEffect(() => {
        let subscribed = true
        const doAsync = async () => {
            if (state === STATE.INITIALIZING) {
                console.log("Running INITIALIZING")
                // setState(STATE.INITIALIZING)
                const _provider = await getProvider()
                const _signer = await getSigner(_provider);
                const _address = _signer ? await _signer.getAddress() : undefined
                const { chainId: _chainId } = await _provider.getNetwork()
                if (subscribed) {
                    setChainId(_chainId)
                    setProvider(_provider)
                    setSigner(_signer)
                    setAddress(_address ? _address : undefined)
                    setAuthProvider(getAuthProvider(_provider, _signer))
                    setERC1400(getERC1400(_provider, _chainId, connectERC1400, _signer))
                    setERC1820Registry(getERC1820Registry(_provider, _signer))
                    setCapTableQue(getCapTableQue(_provider, _signer))
                    setCapTableRegistry(getCapTableRegistry(_provider, _signer))
                    setERC1400AuthValidator(getERC1400AuthValidator(_provider, _signer))
                    setState(_signer ? STATE.PROVIDER_SIGNER_READY : STATE.PROVIDER_READY)
                } else {
                    console.log("INITIALIZING un-subscribed")
                }
            }
        };
        doAsync();
        return () => { subscribed = false }
    }, [state])

    useEffect(() => {
        if (autoInit) {
            init()
        }
    }, [])

    const getAuthProvider = (_provider: providers.Provider, _signer?: Signer) => {
        let instance = _signer ? AuthProvider__factory.connect(ethers.constants.AddressZero, _signer) : AuthProvider__factory.connect(ethers.constants.AddressZero, _provider)
        const contract: SymfoniAuthProvider = {
            instance: instance,
            factory: _signer ? new AuthProvider__factory(_signer) : undefined,
        }
        return contract
    }

    const getERC1820Registry = (_provider: providers.Provider, _signer?: Signer) => {
        let instance = _signer ? ERC1820Registry__factory.connect(ethers.constants.AddressZero, _signer) : ERC1820Registry__factory.connect(ethers.constants.AddressZero, _provider)
        const contract: SymfoniERC1820Registry = {
            instance: instance,
            factory: _signer ? new ERC1820Registry__factory(_signer) : undefined,
        }
        return contract
    }
        ;
    const getCapTableQue = (_provider: providers.Provider, _signer?: Signer) => {
        console.log("Getting capTAbleQUe")
        const contractAddress = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512"
        const instance = _signer ? CapTableQue__factory.connect(contractAddress, _signer) : CapTableQue__factory.connect(contractAddress, _provider)
        const contract: SymfoniCapTableQue = {
            instance: instance,
            factory: _signer ? new CapTableQue__factory(_signer) : undefined,
        }
        return contract
    }
        ;
    const getCapTableRegistry = (_provider: providers.Provider, _signer?: Signer) => {

        const contractAddress = "0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0"
        const instance = _signer ? CapTableRegistry__factory.connect(contractAddress, _signer) : CapTableRegistry__factory.connect(contractAddress, _provider)
        const contract: SymfoniCapTableRegistry = {
            instance: instance,
            factory: _signer ? new CapTableRegistry__factory(_signer) : undefined,
        }
        return contract
    }
        ;
    const getERC1400AuthValidator = (_provider: providers.Provider, _signer?: Signer) => {
        let instance = _signer ? ERC1400AuthValidator__factory.connect(ethers.constants.AddressZero, _signer) : ERC1400AuthValidator__factory.connect(ethers.constants.AddressZero, _provider)
        const contract: SymfoniERC1400AuthValidator = {
            instance: instance,
            factory: _signer ? new ERC1400AuthValidator__factory(_signer) : undefined,
        }
        return contract
    }
        ;


    return (
        <SymfoniContext.Provider value={{
            init: (opts?: InitOpts) => init(opts),
            providers,
            signers,
            forceSigner,
            provider,
            selectedProvider,
            selectedSigner,
            state,
            address,
            chainId,
            signer,
            messages,
            loading,
            ready,
            hasSigner
        }}>

            <AuthProviderContext.Provider value={AuthProvider}>
                <ERC1400Context.Provider value={ERC1400}>
                    <ERC1820RegistryContext.Provider value={ERC1820Registry}>
                        <CapTableQueContext.Provider value={CapTableQue}>
                            <CapTableRegistryContext.Provider value={CapTableRegistry}>
                                <ERC1400AuthValidatorContext.Provider value={ERC1400AuthValidator}>
                                    {state === STATE.DEFAULT || state === STATE.INITIALIZING &&
                                        <div>
                                            {props.loadingComponent
                                                ? props.loadingComponent
                                                : <div>
                                                    <p>Loading Symfoni React...</p>
                                                    {messages.map((msg, i) => (
                                                        <p key={i}>{msg}</p>
                                                    ))}
                                                </div>}
                                        </div>
                                    }
                                    {state === STATE.PROVIDER_READY || state === STATE.PROVIDER_SIGNER_READY &&
                                        props.children
                                    }
                                </ERC1400AuthValidatorContext.Provider >
                            </CapTableRegistryContext.Provider >
                        </CapTableQueContext.Provider >
                    </ERC1820RegistryContext.Provider >
                </ERC1400Context.Provider >
            </AuthProviderContext.Provider >
        </SymfoniContext.Provider>
    )

};
